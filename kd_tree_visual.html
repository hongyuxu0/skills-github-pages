<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>äº¤äº’å¼KDæ ‘å¯è§†åŒ–</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
            padding: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 900px;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input {
            width: 70px;
            padding: 6px;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 6px 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }
        #addPoint { background: #4CAF50; color: white; }
        #addPoint:hover { background: #45a049; }
        #buildTree { background: #2196F3; color: white; }
        #buildTree:hover { background: #0b7dda; }
        #search { background: #FF9800; color: white; }
        #search:hover { background: #e68a00; }
        #clear { background: #f44336; color: white; }
        #clear:hover { background: #d32f2f; }
        #canvas {
            border: 1px solid #ccc;
            background: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            color: #333;
            font-size: 14px;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            font-weight: 500;
            height: 20px; /* å›ºå®šé«˜åº¦é¿å…å¸ƒå±€è·³åŠ¨ */
        }
        .legend {
            display: flex;
            gap: 15px;
            font-size: 12px;
            margin-top: 10px;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }
        h3 {
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            color: #333;
            margin: 0;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        .speed-control label {
            font-size: 13px;
            color: #555;
        }
        #speedSlider {
            width: 120px;
        }
        .speed-value {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <h3>KDæ ‘æ„é€ ä¸æœ€è¿‘é‚»æœç´¢å¯è§†åŒ–</h3>
    <div class="controls">
        <div class="input-group">
            <label>Xï¼š</label>
            <input type="number" id="xInput" step="0.1" value="2" min="0" max="10">
            <label>Yï¼š</label>
            <input type="number" id="yInput" step="0.1" value="3" min="0" max="10">
            <button id="addPoint">æ·»åŠ ç‚¹</button>
        </div>
        <button id="buildTree">æ„å»ºæ ‘</button>
        <div class="input-group">
            <label>æœç´¢Xï¼š</label>
            <input type="number" id="searchX" step="0.1" value="3" min="0" max="10">
            <label>Yï¼š</label>
            <input type="number" id="searchY" step="0.1" value="4.5" min="0" max="10">
            <button id="search">å¼€å§‹æœç´¢</button>
        </div>
        <button id="clear">æ¸…ç©ºå…¨éƒ¨</button>
        <div class="speed-control">
            <label>åŠ¨ç”»é€Ÿåº¦ï¼š</label>
            <input type="range" id="speedSlider" min="500" max="3000" step="100" value="1000">
            <span class="speed-value" id="speedValue">1.0ç§’/æ­¥</span>
        </div>
    </div>
    <div class="status" id="status">æ·»åŠ ç‚¹åç‚¹å‡»â€œæ„å»ºæ ‘â€å¼€å§‹ï¼ˆå»ºè®®æ·»åŠ 3-8ä¸ªç‚¹ï¼‰</div>
    <canvas id="canvas" width="900" height="600"></canvas>
    <div class="legend">
        <div class="legend-item">
            <div class="color-box" style="background: red;"></div>
            <span>æ­£åœ¨æ„å»ºçš„èŠ‚ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #4CAF50;"></div>
            <span>æœªæœç´¢çš„èŠ‚ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: orange;"></div>
            <span>æ­£åœ¨æœç´¢çš„èŠ‚ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: rgba(255,165,0,0.5);"></div>
            <span>å·²æœç´¢å®Œæˆçš„èŠ‚ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: blue;"></div>
            <span>ç›®æ ‡ç‚¹</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: purple;"></div>
            <span>æœ€ç»ˆæœ€è¿‘é‚»</span>
        </div>
        <div class="legend-item">
            <div class="color-box" style="background: #999;"></div>
            <span>æ ‘è¿çº¿</span>
        </div>
    </div>
</div>

<script>
    // èŠ‚ç‚¹ç±»ï¼šå­˜å‚¨KDæ ‘èŠ‚ç‚¹æ ¸å¿ƒä¿¡æ¯
    class Node {
        constructor(axis, value, point, depth) {
            this.axis = axis;          // åˆ†å‰²ç»´åº¦ï¼ˆ0=xè½´ï¼Œ1=yè½´ï¼‰
            this.value = value;        // åˆ†å‰²å€¼ï¼ˆå½“å‰ç»´åº¦åæ ‡ï¼‰
            this.point = point;        // èŠ‚ç‚¹åæ ‡ [x, y]
            this.depth = depth;        // èŠ‚ç‚¹æ·±åº¦
            this.left = null;          // å·¦å­èŠ‚ç‚¹ï¼ˆ<åˆ†å‰²å€¼ï¼‰
            this.right = null;         // å³å­èŠ‚ç‚¹ï¼ˆâ‰¥åˆ†å‰²å€¼ï¼‰
            this.parent = null;        // çˆ¶èŠ‚ç‚¹
            this.pos = { x: 0, y: 0 }; // ç”»å¸ƒåƒç´ åæ ‡
        }
    }

    // KDæ ‘å¯è§†åŒ–æ ¸å¿ƒç±»ï¼ˆæœç´¢ä¸æ¸…é™¤ç”»å¸ƒç‰ˆï¼‰
    class KDTreeVisualizer {
        constructor(canvasId) {
            // ç”»å¸ƒåŸºç¡€é…ç½®
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.canvasWidth = this.canvas.width;
            this.canvasHeight = this.canvas.height;

            // æ•°æ®å­˜å‚¨
            this.points = [];          // ç”¨æˆ·è¾“å…¥çš„åŸå§‹ç‚¹é›†ï¼ˆå»é‡åï¼‰
            this.root = null;          // KDæ ‘æ ¹èŠ‚ç‚¹
            this.buildOrder = [];      // èŠ‚ç‚¹æ„å»ºé¡ºåºï¼ˆåŠ¨ç”»ç”¨ï¼‰
            this.nodeMap = new Map();  // åæ ‡â†’èŠ‚ç‚¹æ˜ å°„ï¼ˆå»é‡ï¼‰
            this.nodePositions = new Map(); // èŠ‚ç‚¹â†’ç”»å¸ƒåæ ‡æ˜ å°„ï¼ˆç¼“å­˜ï¼‰

            // åŠ¨ç”»çŠ¶æ€
            this.animating = false;    // æ˜¯å¦æ­£åœ¨åŠ¨ç”»
            this.buildStep = 0;        // æ„å»ºåŠ¨ç”»è¿›åº¦ï¼ˆå·²æ„å»ºèŠ‚ç‚¹æ•°ï¼‰
            this.searchStep = 0;       // æœç´¢åŠ¨ç”»è¿›åº¦ï¼ˆå·²æœç´¢èŠ‚ç‚¹æ•°ï¼‰
            this.searchPath = [];      // æœç´¢è·¯å¾„ï¼ˆä¸¥æ ¼æŒ‰ç®—æ³•æµç¨‹ï¼‰
            this.targetPoint = null;   // æœç´¢ç›®æ ‡ç‚¹
            this.nearestNeighbor = null;// æœ€è¿‘é‚»èŠ‚ç‚¹
            this.timerId = null;       // å®šæ—¶å™¨IDï¼ˆå•ä¾‹ï¼Œé¿å…å åŠ ï¼‰
            this.animationDelay = 1000;// åŠ¨ç”»æ­¥é•¿å»¶è¿Ÿï¼ˆé»˜è®¤1ç§’ï¼‰

            // ç”»å¸ƒå¸ƒå±€é…ç½®ï¼ˆåŠ¨æ€é€‚é…èŠ‚ç‚¹æ•°é‡ï¼‰
            this.margin = 60;
            this.maxDepth = 0;         // æ ‘çš„æœ€å¤§æ·±åº¦ï¼ˆç”¨äºåŠ¨æ€è°ƒæ•´é—´è·ï¼‰
            this.horizonBase = 150;    // åŸºç¡€æ¨ªå‘é—´è·
            this.verticalStep = 90;    // çºµå‘å±‚çº§é—´è·ï¼ˆå›ºå®šï¼‰
        }

        // è®¾ç½®åŠ¨ç”»é€Ÿåº¦ï¼ˆå¤–éƒ¨æ»‘å—æ§åˆ¶ï¼‰
        setAnimationDelay(delay) {
            this.animationDelay = Math.max(500, Math.min(3000, delay));
        }

        // æ·»åŠ ç‚¹ï¼ˆå»é‡+è¾“å…¥éªŒè¯ï¼‰
        addPoint(x, y) {
            if (this.animating) {
                this.updateStatus("âš ï¸ åŠ¨ç”»è¿›è¡Œä¸­ï¼Œæš‚ä¸èƒ½æ·»åŠ ç‚¹");
                return false;
            }

            // è¾“å…¥éªŒè¯ï¼ˆ0-10ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼‰
            const xNum = parseFloat(x);
            const yNum = parseFloat(y);
            if (isNaN(xNum) || isNaN(yNum) || xNum < 0 || xNum > 10 || yNum < 0 || yNum > 10) {
                this.updateStatus("âš ï¸ è¯·è¾“å…¥0-10ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—");
                return false;
            }

            // å»é‡ï¼ˆç²¾ç¡®åˆ°1ä½å°æ•°ï¼Œé¿å…æµ®ç‚¹è¯¯å·®ï¼‰
            const pointKey = `${xNum.toFixed(1)},${yNum.toFixed(1)}`;
            if (this.nodeMap.has(pointKey)) {
                this.updateStatus(`âš ï¸ ç‚¹(${xNum.toFixed(1)},${yNum.toFixed(1)})å·²å­˜åœ¨`);
                return false;
            }

            // åˆæ³•ç‚¹ï¼šæ·»åŠ åˆ°é›†åˆ
            const newPoint = [xNum, yNum];
            this.points.push(newPoint);
            this.nodeMap.set(pointKey, newPoint);
            this.updateStatus(`âœ… å·²æ·»åŠ ç‚¹(${xNum.toFixed(1)},${yNum.toFixed(1)}) - æ€»ç‚¹æ•°ï¼š${this.points.length}`);
            return true;
        }

        // æ„å»ºKDæ ‘ï¼ˆä¿ç•™ç”»å¸ƒï¼Œä»…æ›´æ–°æ„å»ºçŠ¶æ€ï¼‰
        buildTree() {
            if (this.animating || this.points.length === 0) {
                this.updateStatus(this.points.length === 0 ? "âš ï¸ è¯·å…ˆæ·»åŠ 3-8ä¸ªç‚¹" : "âš ï¸ åŠ¨ç”»è¿›è¡Œä¸­ï¼Œæš‚ä¸èƒ½æ„å»º");
                return;
            }

            // é‡ç½®æ„å»ºçŠ¶æ€ï¼ˆä¸æ¸…ç©ºç”»å¸ƒï¼Œä¿ç•™å†å²æ„å»ºç»“æœï¼‰
            this.clearAnimation(false);
            this.root = null;
            this.buildOrder = [];
            this.nodePositions.clear();

            // æ„å»ºKDæ ‘+è®¡ç®—èŠ‚ç‚¹åæ ‡
            this.root = this._buildRecursive(this.points, 0, null);
            this.maxDepth = this._getTreeMaxDepth(this.root);
            this._calculateNodePositions(this.root);

            // å¯åŠ¨æ„å»ºåŠ¨ç”»ï¼ˆé€èŠ‚ç‚¹ç»˜åˆ¶ï¼Œä¸æ¸…é™¤ä¹‹å‰å†…å®¹ï¼‰
            this.buildStep = 0;
            this.animating = true;
            this.updateStatus("ğŸ”¨ æ­£åœ¨æ„å»ºKDæ ‘...ï¼ˆçº¢è‰²=æ­£åœ¨æ„å»ºï¼Œç»¿è‰²=å·²æ„å»ºï¼‰");
            this._animateBuild();
            return true;
        }

        // é€’å½’æ„å»ºKDæ ‘ï¼ˆç§æœ‰æ–¹æ³•ï¼‰
        _buildRecursive(points, depth, parentNode) {
            if (points.length === 0) return null;

            const k = 2;
            const axis = depth % k;
            // ç¨³å®šæ’åºï¼ˆé¿å…ç›¸åŒå€¼ä¹±åºï¼‰
            const sortedPoints = [...points].sort((a, b) => {
                if (a[axis] !== b[axis]) return a[axis] - b[axis];
                return a[(axis + 1) % k] - b[(axis + 1) % k];
            });

            // å–ä¸­ä½æ•°èŠ‚ç‚¹
            const medianIdx = Math.floor(sortedPoints.length / 2);
            const medianPoint = sortedPoints[medianIdx];
            const node = new Node(axis, medianPoint[axis], medianPoint, depth);
            node.parent = parentNode;
            this.buildOrder.push(node);

            // é€’å½’æ„å»ºå·¦å³å­æ ‘
            node.left = this._buildRecursive(sortedPoints.slice(0, medianIdx), depth + 1, node);
            node.right = this._buildRecursive(sortedPoints.slice(medianIdx + 1), depth + 1, node);

            return node;
        }

        // è·å–æ ‘çš„æœ€å¤§æ·±åº¦ï¼ˆç§æœ‰æ–¹æ³•ï¼‰
        _getTreeMaxDepth(node) {
            if (!node) return 0;
            const leftDepth = this._getTreeMaxDepth(node.left);
            const rightDepth = this._getTreeMaxDepth(node.right);
            return Math.max(leftDepth, rightDepth) + 1;
        }

        // è®¡ç®—èŠ‚ç‚¹ç”»å¸ƒåæ ‡ï¼ˆç§æœ‰æ–¹æ³•ï¼‰
        _calculateNodePositions(node) {
            if (!node) return;

            // æ ¹èŠ‚ç‚¹ä½ç½®ï¼šå±…ä¸­é¡¶éƒ¨
            const rootX = this.canvasWidth / 2;
            const rootY = this.margin + 40;
            this.nodePositions.set(node, { x: rootX, y: rootY });

            // BFSéå†ï¼šåŠ¨æ€æ¨ªå‘é—´è·ï¼ˆé¿å…é‡å ï¼‰
            const queue = [node];
            while (queue.length > 0) {
                const currNode = queue.shift();
                const currPos = this.nodePositions.get(currNode);
                const level = currNode.depth + 1;
                const horizonGap = this.horizonBase / Math.pow(2, Math.min(level, this.maxDepth / 2));

                // å·¦å­èŠ‚ç‚¹
                if (currNode.left) {
                    const leftX = currPos.x - horizonGap;
                    const leftY = currPos.y + this.verticalStep;
                    currNode.left.pos = { x: leftX, y: leftY };
                    this.nodePositions.set(currNode.left, currNode.left.pos);
                    queue.push(currNode.left);
                }

                // å³å­èŠ‚ç‚¹
                if (currNode.right) {
                    const rightX = currPos.x + horizonGap;
                    const rightY = currPos.y + this.verticalStep;
                    currNode.right.pos = { x: rightX, y: rightY };
                    this.nodePositions.set(currNode.right, currNode.right.pos);
                    queue.push(currNode.right);
                }
            }
        }

        // å¼€å§‹æœ€è¿‘é‚»æœç´¢ï¼ˆæ ¸å¿ƒï¼šä¸æ¸…é™¤ç”»å¸ƒï¼Œé¢œè‰²åŠ¨æ€å åŠ ï¼‰
        startSearch(targetX, targetY) {
            if (this.animating || !this.root) {
                this.updateStatus(!this.root ? "âš ï¸ è¯·å…ˆæ„å»ºKDæ ‘" : "âš ï¸ åŠ¨ç”»è¿›è¡Œä¸­ï¼Œæš‚ä¸èƒ½æœç´¢");
                return;
            }

            // è¾“å…¥éªŒè¯
            const tx = parseFloat(targetX);
            const ty = parseFloat(targetY);
            if (isNaN(tx) || isNaN(ty) || tx < 0 || tx > 10 || ty < 0 || ty > 10) {
                this.updateStatus("âš ï¸ è¯·è¾“å…¥0-10ä¹‹é—´çš„æœ‰æ•ˆæœç´¢åæ ‡");
                return;
            }

            // é‡ç½®æœç´¢çŠ¶æ€ï¼ˆå…³é”®ï¼šä¸æ¸…ç©ºç”»å¸ƒï¼Œä¿ç•™æ„å»ºé˜¶æ®µçš„èŠ‚ç‚¹å’Œè¿çº¿ï¼‰
            this.clearAnimation(false);
            this.targetPoint = [tx, ty];
            this.searchPath = [];
            this.nearestNeighbor = null;
            let minDist = Infinity;

            // 1. å…ˆç»˜åˆ¶ç›®æ ‡ç‚¹ï¼ˆåªç”»ä¸€æ¬¡ï¼Œä¸é‡å¤æ¸…é™¤ï¼‰
            this._drawTargetPoint();
            // 2. é€’å½’æœç´¢ï¼ˆè®°å½•è·¯å¾„ï¼‰
            this._searchRecursive(this.root, tx, ty, minDist);
            this.searchPath = [...new Set(this.searchPath)]; // å»é‡è·¯å¾„

            // 3. å¯åŠ¨æœç´¢åŠ¨ç”»ï¼ˆé¢œè‰²åŠ¨æ€æ›´æ–°æœç´¢è·¯å¾„èŠ‚ç‚¹ï¼‰
            this.searchStep = 0;
            this.animating = true;
            this.updateStatus(`ğŸ” æ­£åœ¨æœç´¢ç›®æ ‡ç‚¹(${tx.toFixed(1)},${ty.toFixed(1)})...ï¼ˆæ©™è‰²=æ­£åœ¨æœï¼Œæµ…æ©™=å·²æœå®Œï¼‰`);
            this._animateSearch();
        }

        // é€’å½’æœç´¢ï¼ˆç§æœ‰æ–¹æ³•ï¼šä¸¥æ ¼æŒ‰KDæ ‘ç®—æ³•è®°å½•è·¯å¾„ï¼‰
        _searchRecursive(node, tx, ty, minDist) {
            if (!node) return minDist;

            // 1. è®°å½•å½“å‰èŠ‚ç‚¹åˆ°æœç´¢è·¯å¾„ï¼ˆç®—æ³•æµç¨‹ç¬¬ä¸€æ­¥ï¼‰
            this.searchPath.push(node);

            // 2. è®¡ç®—å½“å‰èŠ‚ç‚¹åˆ°ç›®æ ‡ç‚¹çš„è·ç¦»
            const dx = node.point[0] - tx;
            const dy = node.point[1] - ty;
            const currDist = Math.sqrt(dx * dx + dy * dy);

            // 3. æ›´æ–°æœ€è¿‘é‚»
            if (currDist < minDist) {
                minDist = currDist;
                this.nearestNeighbor = node;
            }

            // 4. å†³å®šä¼˜å…ˆæœç´¢çš„å­æ ‘
            const axis = node.axis;
            const isLeftPriority = axis === 0 ? (tx < node.value) : (ty < node.value);
            const priorityChild = isLeftPriority ? node.left : node.right;
            const otherChild = isLeftPriority ? node.right : node.left;

            // 5. å…ˆæœä¼˜å…ˆå­æ ‘ï¼Œå†å›æº¯æ£€æŸ¥å¦ä¸€å­æ ‘
            minDist = this._searchRecursive(priorityChild, tx, ty, minDist);
            if (Math.abs(axis === 0 ? tx - node.value : ty - node.value) < minDist) {
                minDist = this._searchRecursive(otherChild, tx, ty, minDist);
            }

            return minDist;
        }

        // æ„å»ºåŠ¨ç”»ï¼ˆé€èŠ‚ç‚¹ç»˜åˆ¶ï¼Œä¸æ¸…é™¤ç”»å¸ƒï¼‰
        _animateBuild() {
            if (this.buildStep >= this.buildOrder.length) {
                this.animating = false;
                this.updateStatus(`âœ… KDæ ‘æ„å»ºå®Œæˆï¼å…±${this.buildOrder.length}ä¸ªèŠ‚ç‚¹ï¼ˆç»¿è‰²=æœªæœç´¢ï¼‰`);
                return;
            }

            // 1. ç»˜åˆ¶å½“å‰æ„å»ºçš„èŠ‚ç‚¹ï¼ˆçº¢è‰²ï¼‰
            const currNode = this.buildOrder[this.buildStep];
            const currPos = this.nodePositions.get(currNode);
            if (currPos) {
                // ç»˜åˆ¶èŠ‚ç‚¹ï¼ˆçº¢è‰²=æ­£åœ¨æ„å»ºï¼‰
                this.ctx.beginPath();
                this.ctx.arc(currPos.x, currPos.y, 16, 0, Math.PI * 2);
                this.ctx.fillStyle = "red";
                this.ctx.strokeStyle = "#C62828";
                this.ctx.lineWidth = 1.5;
                this.ctx.fill();
                this.ctx.stroke();

                // ç»˜åˆ¶èŠ‚ç‚¹åæ ‡ï¼ˆç™½è‰²æ–‡å­—ï¼‰
                this.ctx.fillStyle = "white";
                this.ctx.font = "12px å¾®è½¯é›…é»‘";
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                const pointText = `(${currNode.point[0].toFixed(1)},${currNode.point[1].toFixed(1)})`;
                this.ctx.fillText(pointText, currPos.x, currPos.y);

                // ç»˜åˆ¶ä¸çˆ¶èŠ‚ç‚¹çš„è¿çº¿ï¼ˆç°è‰²ï¼Œåªç”»ä¸€æ¬¡ï¼‰
                if (currNode.parent) {
                    const parentPos = this.nodePositions.get(currNode.parent);
                    this.ctx.beginPath();
                    this.ctx.moveTo(parentPos.x, parentPos.y);
                    this.ctx.lineTo(currPos.x, currPos.y);
                    this.ctx.strokeStyle = "#999";
                    this.ctx.lineWidth = 1.2;
                    this.ctx.stroke();
                }

                // 2. å°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹è®¾ä¸ºâ€œå·²æ„å»ºâ€ï¼ˆç»¿è‰²ï¼Œè¦†ç›–çº¢è‰²ï¼‰
                if (this.buildStep > 0) {
                    const prevNode = this.buildOrder[this.buildStep - 1];
                    const prevPos = this.nodePositions.get(prevNode);
                    this.ctx.beginPath();
                    this.ctx.arc(prevPos.x, prevPos.y, 14, 0, Math.PI * 2);
                    this.ctx.fillStyle = "#4CAF50";
                    this.ctx.strokeStyle = "#388E3C";
                    this.ctx.lineWidth = 1.5;
                    this.ctx.fill();
                    this.ctx.stroke();

                    // é‡ç»˜ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„åæ ‡ï¼ˆé»‘è‰²æ–‡å­—ï¼‰
                    this.ctx.fillStyle = "black";
                    this.ctx.fillText(`(${prevNode.point[0].toFixed(1)},${prevNode.point[1].toFixed(1)})`, prevPos.x, prevPos.y);
                }
            }

            // æ¨è¿›è¿›åº¦
            this.buildStep++;
            if (this.timerId) clearTimeout(this.timerId);
            this.timerId = setTimeout(() => {
                this._animateBuild();
            }, this.animationDelay);
        }

        // æœç´¢åŠ¨ç”»ï¼ˆæ ¸å¿ƒï¼šé¢œè‰²åŠ¨æ€å åŠ ï¼Œä¸æ¸…é™¤ç”»å¸ƒï¼‰
        _animateSearch() {
            if (this.searchStep >= this.searchPath.length) {
                this.animating = false;
                // 1. é«˜äº®æœ€è¿‘é‚»ï¼ˆç´«è‰²è¦†ç›–ï¼Œçªå‡ºç»“æœï¼‰
                const nn = this.nearestNeighbor;
                const nnPos = this.nodePositions.get(nn);
                this.ctx.beginPath();
                this.ctx.arc(nnPos.x, nnPos.y, 18, 0, Math.PI * 2);
                this.ctx.fillStyle = "purple";
                this.ctx.strokeStyle = "#6A1B9A";
                this.ctx.lineWidth = 2;
                this.ctx.fill();
                this.ctx.stroke();

                // ç»˜åˆ¶æœ€è¿‘é‚»æ ‡ç­¾ï¼ˆç™½è‰²æ–‡å­—ï¼‰
                this.ctx.fillStyle = "white";
                this.ctx.font = "12px å¾®è½¯é›…é»‘";
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                const nnText = `æœ€è¿‘é‚»\n(${nn.point[0].toFixed(1)},${nn.point[1].toFixed(1)})`;
                this.ctx.fillText(nnText, nnPos.x, nnPos.y);

                // 2. ç»˜åˆ¶ç›®æ ‡ç‚¹åˆ°æœ€è¿‘é‚»çš„è™šçº¿ï¼ˆç´«è‰²ï¼Œæ ‡è®°å…³è”ï¼‰
                const targetPos = { x: this.margin + 50, y: this.canvasHeight - this.margin - 50 };
                this.ctx.beginPath();
                this.ctx.moveTo(targetPos.x, targetPos.y);
                this.ctx.lineTo(nnPos.x, nnPos.y);
                this.ctx.strokeStyle = "purple";
                this.ctx.lineWidth = 1.5;
                this.ctx.setLineDash([5, 3]);
                this.ctx.stroke();
                this.ctx.setLineDash([]);

                // 3. æ›´æ–°çŠ¶æ€æç¤º
                const dist = Math.sqrt(Math.pow(nn.point[0] - this.targetPoint[0], 2) + Math.pow(nn.point[1] - this.targetPoint[1], 2));
                this.updateStatus(`âœ… æœç´¢å®Œæˆï¼æœ€è¿‘é‚»ï¼š(${nn.point[0].toFixed(1)},${nn.point[1].toFixed(1)})ï¼Œè·ç¦»ï¼š${dist.toFixed(2)}`);
                return;
            }

            // 1. å¤„ç†â€œå·²æœç´¢å®Œæˆâ€çš„èŠ‚ç‚¹ï¼ˆæµ…æ©™è‰²è¦†ç›–ç»¿è‰²/æ©™è‰²ï¼‰
            if (this.searchStep > 0) {
                const prevNode = this.searchPath[this.searchStep - 1];
                const prevPos = this.nodePositions.get(prevNode);
                this.ctx.beginPath();
                this.ctx.arc(prevPos.x, prevPos.y, 14, 0, Math.PI * 2);
                this.ctx.fillStyle = "rgba(255,165,0,0.5)"; // æµ…æ©™è‰²=å·²æœå®Œ
                this.ctx.strokeStyle = "rgba(255,140,0,0.7)";
                this.ctx.lineWidth = 1.5;
                this.ctx.fill();
                this.ctx.stroke();

                // é‡ç»˜åæ ‡ï¼ˆé»‘è‰²æ–‡å­—ï¼‰
                this.ctx.fillStyle = "black";
                this.ctx.font = "12px å¾®è½¯é›…é»‘";
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";
                const prevText = `(${prevNode.point[0].toFixed(1)},${prevNode.point[1].toFixed(1)})`;
                this.ctx.fillText(prevText, prevPos.x, prevPos.y);
            }

            // 2. å¤„ç†â€œæ­£åœ¨æœç´¢â€çš„èŠ‚ç‚¹ï¼ˆæ©™è‰²è¦†ç›–ç»¿è‰²ï¼‰
            const currNode = this.searchPath[this.searchStep];
            const currPos = this.nodePositions.get(currNode);
            this.ctx.beginPath();
            this.ctx.arc(currPos.x, currPos.y, 16, 0, Math.PI * 2);
            this.ctx.fillStyle = "orange"; // æ©™è‰²=æ­£åœ¨æœ
            this.ctx.strokeStyle = "#E65100";
            this.ctx.lineWidth = 1.5;
            this.ctx.fill();
            this.ctx.stroke();

            // é‡ç»˜åæ ‡ï¼ˆç™½è‰²æ–‡å­—ï¼‰
            this.ctx.fillStyle = "white";
            this.ctx.fillText(`(${currNode.point[0].toFixed(1)},${currNode.point[1].toFixed(1)})`, currPos.x, currPos.y);

            // æ¨è¿›è¿›åº¦
            this.searchStep++;
            if (this.timerId) clearTimeout(this.timerId);
            this.timerId = setTimeout(() => {
                this._animateSearch();
            }, this.animationDelay);
        }

        // ç»˜åˆ¶ç›®æ ‡ç‚¹ï¼ˆåªç”»ä¸€æ¬¡ï¼Œä¸é‡å¤æ¸…é™¤ï¼‰
        _drawTargetPoint() {
            if (!this.targetPoint) return;

            // ç›®æ ‡ç‚¹ä½ç½®ï¼šå·¦ä¸‹è§’ï¼ˆè¿œç¦»æ ‘ç»“æ„ï¼Œé¿å…é‡å ï¼‰
            const targetPos = {
                x: this.margin + 50,
                y: this.canvasHeight - this.margin - 50
            };

            // ç»˜åˆ¶ç›®æ ‡ç‚¹ï¼ˆè“è‰²ï¼Œåªç”»ä¸€æ¬¡ï¼‰
            this.ctx.beginPath();
            this.ctx.arc(targetPos.x, targetPos.y, 14, 0, Math.PI * 2);
            this.ctx.fillStyle = "blue";
            this.ctx.strokeStyle = "#1565C0";
            this.ctx.lineWidth = 1.5;
            this.ctx.fill();
            this.ctx.stroke();

            // ç»˜åˆ¶ç›®æ ‡ç‚¹æ ‡ç­¾ï¼ˆç™½è‰²æ–‡å­—ï¼‰
            this.ctx.fillStyle = "white";
            this.ctx.font = "12px å¾®è½¯é›…é»‘";
            this.ctx.textAlign = "center";
            this.ctx.textBaseline = "middle";
            const targetText = `ç›®æ ‡\n(${this.targetPoint[0].toFixed(1)},${this.targetPoint[1].toFixed(1)})`;
            this.ctx.fillText(targetText, targetPos.x, targetPos.y);
        }

        // æ¸…é™¤åŠ¨ç”»çŠ¶æ€ï¼ˆå…³é”®ï¼šé»˜è®¤ä¸æ¸…ç©ºç”»å¸ƒï¼‰
        clearAnimation(clearCanvas = false) {
            if (this.timerId) clearTimeout(this.timerId);
            this.animating = false;
            this.buildStep = 0;
            this.searchStep = 0;
            this.searchPath = [];
            this.targetPoint = null;
            this.nearestNeighbor = null;

            // ä»…åœ¨â€œæ¸…ç©ºå…¨éƒ¨â€æ—¶æ‰æ¸…ç©ºç”»å¸ƒ
            if (clearCanvas) {
                this.ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
            }
        }

        // æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆé‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Œæ¸…ç©ºç”»å¸ƒï¼‰
        clearAll() {
            this.clearAnimation(true); // æ¸…ç©ºç”»å¸ƒ
            this.points = [];
            this.root = null;
            this.buildOrder = [];
            this.nodeMap.clear();
            this.nodePositions.clear();
            this.maxDepth = 0;
            this.updateStatus("ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œè¯·æ·»åŠ 3-8ä¸ªç‚¹é‡æ–°å¼€å§‹");

            // é‡ç½®è¾“å…¥æ¡†
            document.getElementById('xInput').value = 2;
            document.getElementById('yInput').value = 3;
            document.getElementById('searchX').value = 3;
            document.getElementById('searchY').value = 4.5;
        }

        // æ›´æ–°çŠ¶æ€æç¤º
        updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆé¿å…DOMæœªå°±ç»ªï¼‰
    window.addEventListener('load', () => {
        const visualizer = new KDTreeVisualizer('canvas');

        // 1. ç»‘å®šâ€œæ·»åŠ ç‚¹â€æŒ‰é’®
        document.getElementById('addPoint').addEventListener('click', () => {
            const x = document.getElementById('xInput').value;
            const y = document.getElementById('yInput').value;
            visualizer.addPoint(x, y);
        });

        // 2. ç»‘å®šâ€œæ„å»ºæ ‘â€æŒ‰é’®
        document.getElementById('buildTree').addEventListener('click', () => {
            visualizer.buildTree();
        });

        // 3. ç»‘å®šâ€œå¼€å§‹æœç´¢â€æŒ‰é’®
        document.getElementById('search').addEventListener('click', () => {
            const x = document.getElementById('searchX').value;
            const y = document.getElementById('searchY').value;
            visualizer.startSearch(x, y);
        });

        // 4. ç»‘å®šâ€œæ¸…ç©ºå…¨éƒ¨â€æŒ‰é’®
        document.getElementById('clear').addEventListener('click', () => {
            visualizer.clearAll();
        });

        // 5. ç»‘å®šâ€œé€Ÿåº¦æ»‘å—â€äº‹ä»¶
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        speedSlider.addEventListener('input', (e) => {
            const delay = parseInt(e.target.value);
            visualizer.setAnimationDelay(delay);
            speedValue.textContent = `${(delay / 1000).toFixed(1)}ç§’/æ­¥`;
        });

        // 6. ç»‘å®šâ€œEnteré”®â€è§¦å‘
        ['xInput', 'yInput'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('addPoint').click();
            });
        });
        ['searchX', 'searchY'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('search').click();
            });
        });
    });
</script>
</body>
</html>

